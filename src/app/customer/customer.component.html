<div class="customer-page">
  <p *ngIf="message" class="message">{{ message }}</p>

  <!-- CUSTOMER HEADER -->
  <div class="customer-header">
    <h1>{{ 'CUSTOMER_LIST' | translate }}</h1>
    <div class="search-section" *ngIf="!showBatchUpdateSection">
      <div class="search-controls">
        <select [(ngModel)]="searchCriteria" class="search-criteria">
          <option value="all">{{ 'SHOW_ALL' | translate }}</option>
          <option value="customerName">{{ 'CUSTOMER_NAME' | translate }}</option>
          <option value="customerCode">{{ 'CUSTOMER_CODE' | translate }}</option>
          <option value="contactPerson">{{ 'CONTACT_PERSON' | translate }}</option>
          <option value="phoneNumber">{{ 'PHONE_NUMBER' | translate }}</option>
          <option value="customerType">{{ 'CUSTOMER_TYPE' | translate }}</option>
          <option value="county">{{ 'COUNTY' | translate }}</option>
        </select>
        
        <!-- 根據搜尋條件顯示不同的輸入框或下拉選單 -->
        <input
          *ngIf="searchCriteria === 'customerName' || searchCriteria === 'customerCode' || searchCriteria === 'contactPerson' || searchCriteria === 'phoneNumber'"
          type="text"
          [(ngModel)]="searchTerm"
          [placeholder]="'ENTER_SEARCH_VALUE' | translate"
          class="search-input"
        >
        
        <!-- 客戶類型下拉選單 -->
        <select
          *ngIf="searchCriteria === 'customerType'"
          [(ngModel)]="searchTerm"
          class="search-input"
        >
          <option value="">{{ 'SELECT_CUSTOMER_TYPE' | translate }}</option>
          <option *ngFor="let type of customerTypes" [value]="type.id">{{ type.type_name }}</option>
        </select>
        
        <!-- 縣市下拉選單 -->
        <select
          *ngIf="searchCriteria === 'county'"
          [(ngModel)]="countyValue"
          class="search-input county-select"
          (change)="onCountyChange()"
        >
          <option value="">{{ 'SELECT_COUNTY' | translate }}</option>
          <option *ngFor="let county of counties" [value]="county">{{ county }}</option>
        </select>
        
        <!-- 區域下拉選單（在選擇縣市後顯示） -->
        <select
          *ngIf="showDistrictDropdown && searchCriteria === 'county'"
          [(ngModel)]="districtValue"
          class="search-input district-select"
        >
          <option value="">{{ 'SELECT_DISTRICT' | translate }}</option>
          <option value="all">{{ 'ALL_DISTRICTS' | translate }}</option>
          <option *ngFor="let district of districts" [value]="district">{{ district }}</option>
        </select>
        
        <button (click)="onSearch()" class="search-btn">{{ 'SEARCH' | translate }}</button>
      </div>
      
      <!-- 將按鈕移到搜尋按鈕下方 -->
      <div class="action-buttons">
        <button (click)="navigateToAddCustomerPage()" *ngIf="!showBatchUpdateSection">{{ 'ADD_CUSTOMER' | translate }}</button>
        <button (click)="toggleBatchUpdateMode()" class="batch-update-btn">
          {{ showBatchUpdateSection ? ('HIDE_BATCH_UPDATE' | translate) : ('SHOW_BATCH_UPDATE' | translate) }}
        </button>
        <button (click)="toggleColumnConfigPanel()" class="column-config-btn" *ngIf="!showBatchUpdateSection">
          {{ '自定義欄位' }}
        </button>
      </div>
    </div>
    <!-- 在批次修改模式下顯示"隱藏批次修改"按鈕和搜尋控件 -->
    <div class="action-buttons batch-update-header" *ngIf="showBatchUpdateSection">
      <button (click)="toggleBatchUpdateMode()" class="batch-update-btn">
        {{ 'HIDE_BATCH_UPDATE' | translate }}
      </button>
      <div class="search-controls">
        <select [(ngModel)]="searchCriteria" class="search-criteria">
          <option value="customerName">{{ 'CUSTOMER_NAME' | translate }}</option>
          <option value="customerType">{{ 'CUSTOMER_TYPE' | translate }}</option>
          <option value="county">{{ 'COUNTY' | translate }}</option>
        </select>
        
        <!-- 根據搜尋條件顯示不同的輸入框或下拉選單 -->
        <input
          *ngIf="searchCriteria === 'customerName'"
          type="text"
          [(ngModel)]="searchValue"
          [placeholder]="'ENTER_SEARCH_VALUE' | translate"
          class="search-input"
        >
        
        <!-- 客戶類型下拉選單 -->
        <select
          *ngIf="searchCriteria === 'customerType'"
          [(ngModel)]="searchValue"
          class="search-input"
        >
          <option value="">{{ 'SELECT_CUSTOMER_TYPE' | translate }}</option>
          <option *ngFor="let type of customerTypes" [value]="type.id">{{ type.type_name }}</option>
        </select>
        
        <!-- 縣市下拉選單 -->
        <select
          *ngIf="searchCriteria === 'county'"
          [(ngModel)]="countyValue"
          class="search-input county-select"
          (change)="onCountyChange()"
        >
          <option value="">{{ 'SELECT_COUNTY' | translate }}</option>
          <option *ngFor="let county of counties" [value]="county">{{ county }}</option>
        </select>
        
        <!-- 區域下拉選單（在選擇縣市後顯示） -->
        <label *ngIf="showDistrictDropdown && searchCriteria === 'county'" class="district-label">
          {{ 'DISTRICT' | translate }}:
          <select
            [(ngModel)]="districtValue"
            class="search-input"
          >
            <option value="">{{ 'SELECT_DISTRICT' | translate }}</option>
            <option value="all">{{ 'ALL_DISTRICTS' | translate }}</option>
            <option *ngFor="let district of batchUpdateDistricts" [value]="district">{{ district }}</option>
          </select>
        </label>
        
        <button (click)="searchForBatchUpdate()" class="search-btn">{{ 'SEARCH' | translate }}</button>
      </div>
    </div>
  </div>

  <!-- COLUMN CONFIG PANEL -->
  <div class="column-config-panel" *ngIf="showColumnConfigPanel && !showBatchUpdateSection">
    <div class="panel-header">
      <h3>自定義欄位顯示</h3>
      <button (click)="resetToDefaultConfig()" class="reset-btn">重置為默認</button>
    </div>
    <div class="column-list">
      <div *ngFor="let column of columnConfig" class="column-item">
        <label>
          <input 
            type="checkbox" 
            [checked]="column.visible" 
            (change)="toggleColumnVisibility(column.key)"
            [disabled]="column.fixed">
          {{ column.label | translate }}
        </label>
      </div>
    </div>
    <div class="panel-footer">
      <button (click)="toggleColumnConfigPanel()" class="close-btn">關閉</button>
    </div>
  </div>
  
  <!-- BATCH UPDATE SECTION -->
  <div class="batch-update-section" *ngIf="showBatchUpdateSection">
    <div class="batch-update-controls">
      <div class="batch-actions" *ngIf="batchUpdateCustomers.length > 0">
        <button 
          (click)="toggleBatchUpdateSelectionMode()" 
          class="toggle-selection-btn"
          [class.active]="isBatchUpdateMode">
          {{ isBatchUpdateMode ? ('CANCEL_SELECTION' | translate) : ('SELECT_CUSTOMERS' | translate) }}
        </button>
        <button 
          (click)="toggleSelectAll()" 
          class="select-all-btn"
          *ngIf="isBatchUpdateMode">
          {{ selectedCustomerIds.size === batchUpdateCustomers.length ? ('DESELECT_ALL' | translate) : ('SELECT_ALL' | translate) }}
        </button>
        <button 
          (click)="executeBatchUpdate()" 
          class="batch-update-btn"
          *ngIf="isBatchUpdateMode"
          [disabled]="selectedCustomerIds.size === 0">
          {{ 'BATCH_UPDATE' | translate }}
        </button>
      </div>
    </div>
    
    <!-- BATCH UPDATE CUSTOMER LIST -->
    <div class="batch-update-customer-table-container" *ngIf="batchUpdateCustomers.length > 0">
      <table class="customer-table batch-update-table">
        <thead>
          <tr>
            <th *ngIf="isBatchUpdateMode">
              <input 
                type="checkbox" 
                (change)="toggleSelectAll()"
                [checked]="selectedCustomerIds.size === batchUpdateCustomers.length">
            </th>
            <th>{{ 'CUSTOMER_CODE' | translate }}</th>
            <th>{{ 'CUSTOMER_NAME' | translate }}</th>
            <th>{{ 'CUSTOMER_TYPE' | translate }}</th>
            <th>{{ 'CONTACT_PERSON' | translate }}</th>
            <th>{{ 'PHONE_NUMBER' | translate }}</th>
            <th>{{ 'PAYMENT_METHOD' | translate }}</th>
            <th>{{ 'CREDIT_LIMIT' | translate }}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let customer of batchUpdateCustomers" class="customer-row">
            <td *ngIf="isBatchUpdateMode">
              <input 
                type="checkbox" 
                [checked]="selectedCustomerIds.has(customer.id)"
                (change)="toggleCustomerSelection(customer.id)">
            </td>
            <td>{{ customer.customerCode }}</td>
            <td>{{ customer.customerName }}</td>
            <td>{{ getCustomerTypeText(customer) }}</td>
            <td>{{ customer.contactPerson || '-' }}</td>
            <td>{{ customer.phoneNumber || '-' }}</td>
            <td>{{ customer.paymentMethod || '-' }}</td>
            <td>{{ customer.creditLimit | currency:'TWD':'symbol':'1.0-0' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- NO BATCH CUSTOMERS MESSAGE -->
    <div *ngIf="batchUpdateCustomers.length === 0 && showBatchUpdateSection" class="no-customers">
      <p>{{ 'NO_CUSTOMERS_FOUND_FOR_BATCH_UPDATE' | translate }}</p>
    </div>
  </div>

  <!-- CUSTOMER LIST -->
  <div class="customer-table-container" *ngIf="filteredCustomers.length > 0 && !showBatchUpdateSection">
    <table class="customer-table">
      <thead>
        <tr>
          <th *ngFor="let column of getVisibleColumns()">
            {{ column.label | translate }}
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let customer of filteredCustomers" class="customer-row">
          <td *ngFor="let column of getVisibleColumns()">
            <span *ngIf="column.key !== 'actions'">
              {{ getCustomerValue(customer, column.key) }}
            </span>
            <span *ngIf="column.key === 'actions'" class="actions">
              <button class="edit-btn" (click)="navigateToEditCustomerPage(customer.id)">
                {{ 'EDIT' | translate }}
              </button>
              <button class="delete-btn" (click)="handleDeleteCustomer(customer.id)">
                {{ 'DELETE' | translate }}
              </button>
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- NO CUSTOMERS MESSAGE -->
  <div *ngIf="filteredCustomers.length === 0 && !showBatchUpdateSection" class="no-customers">
    <p *ngIf="searchTerm; else noCustomersTemplate">
      {{ 'NO_CUSTOMERS_FOUND' | translate }}{{ searchTerm }}
    </p>
    <ng-template #noCustomersTemplate>
      <p>{{ 'NO_CUSTOMERS_AVAILABLE' | translate }}</p>
    </ng-template>
  </div>
</div>
